{% extends "base.html" %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<style>
    /* Custom styling for Tom Select to match Tailwind/Scout theme */
    .ts-control {
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        border-color: #d1d5db;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .ts-control:focus {
        border-color: #36a772;
        box-shadow: 0 0 0 3px rgba(54, 167, 114, 0.5);
    }

    .ts-dropdown .active {
        background-color: #e1f8e8;
        color: #1d553d;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 sm:px-0">
    <div class="flex flex-col md:flex-row gap-6">
        <!-- Form Section -->
        <div class="glass p-8 rounded-xl shadow-lg flex-1">
            <h1 class="text-2xl font-bold text-scout-800 mb-6 text-center">Registra Completamento</h1>

            {% if request.query_params.get('error') == 'already_completed' %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Errore!</strong>
                <span class="block sm:inline">Questa pattuglia ha gi√† completato questa sfida.</span>
            </div>
            {% endif %}

            <form action="/complete" method="post" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona Pattuglia</label>
                    <select name="pattuglia_id" id="pattuglia-select" required placeholder="Cerca una pattuglia..."
                        autocomplete="off">
                        <option value="">Cerca una pattuglia...</option>
                        {% for p in pattuglie %}
                        <option value="{{ p.id }}" data-unit="{{ p.unita.name }}" data-cp="{{ p.capo_pattuglia }}">
                            {{ p.name }} ({{ p.unita.name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona Sfida</label>
                    <select name="challenge_id" id="challenge-select" required placeholder="Cerca una sfida..."
                        autocomplete="off">
                        <option value="">Cerca una sfida...</option>
                        {% for c in challenges %}
                        <option value="{{ c.id }}" data-points="{{ c.points }}" data-fungo="{{ c.is_fungo }}">
                            {{ c.name }} (+{{ c.points }} pt) {% if c.is_fungo %}üçÑ{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-scout-600 hover:bg-scout-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-scout-500 transition-transform transform hover:scale-105 mt-4">
                    Registra Punti
                </button>
            </form>
        </div>

        <!-- Summary Section -->
        <div class="glass p-8 rounded-xl shadow-lg w-full md:w-1/3 h-fit sticky top-24">
            <h2 class="text-xl font-bold text-scout-800 mb-4 border-b border-gray-200 pb-2">Riepilogo</h2>

            <div id="summary-empty" class="text-gray-500 text-sm italic text-center py-4">
                Seleziona una pattuglia e una sfida per vedere l'anteprima.
            </div>

            <div id="summary-content" class="hidden space-y-4">
                <!-- Pattuglia Info -->
                <div id="summary-pattuglia" class="hidden bg-white/50 p-3 rounded-lg border border-gray-100">
                    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Pattuglia</div>
                    <div class="font-bold text-lg text-scout-900" id="sp-name"></div>
                    <div class="text-sm text-gray-600">Capo: <span id="sp-cp"></span></div>
                    <div class="text-xs inline-block bg-scout-100 text-scout-800 px-2 py-0.5 rounded-full mt-1"
                        id="sp-unit"></div>
                </div>

                <!-- Challenge Info -->
                <div id="summary-challenge" class="hidden bg-white/50 p-3 rounded-lg border border-gray-100">
                    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Sfida</div>
                    <div class="font-bold text-lg text-scout-900" id="sc-name"></div>
                    <div class="flex items-center mt-1">
                        <span class="text-2xl font-bold text-scout-600 mr-2" id="sc-points"></span>
                        <span class="text-sm text-gray-600">punti</span>
                    </div>
                    <div id="sc-fungo"
                        class="hidden mt-2 text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded inline-block">
                        üçÑ Sfida Fungo
                    </div>
                </div>

                <!-- Total Preview -->
                <div id="summary-total" class="hidden border-t border-gray-200 pt-4 mt-4">
                    <div class="text-center">
                        <span class="text-sm text-gray-500">Punti totali da assegnare:</span>
                        <div class="text-3xl font-extrabold text-scout-700" id="total-points"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Tom Select
        const pSelect = new TomSelect('#pattuglia-select', {
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            }
        });

        const cSelect = new TomSelect('#challenge-select', {
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            }
        });

        // Summary Logic
        const summaryEmpty = document.getElementById('summary-empty');
        const summaryContent = document.getElementById('summary-content');

        const summaryPattuglia = document.getElementById('summary-pattuglia');
        const spName = document.getElementById('sp-name');
        const spCp = document.getElementById('sp-cp');
        const spUnit = document.getElementById('sp-unit');

        const summaryChallenge = document.getElementById('summary-challenge');
        const scName = document.getElementById('sc-name');
        const scPoints = document.getElementById('sc-points');
        const scFungo = document.getElementById('sc-fungo');

        const summaryTotal = document.getElementById('summary-total');
        const totalPoints = document.getElementById('total-points');

        function updateSummary() {
            const pVal = pSelect.getValue();
            const cVal = cSelect.getValue();

            let hasP = false;
            let hasC = false;

            // Update Pattuglia
            if (pVal) {
                // Access the original option to get data attributes reliably
                const originalOption = document.querySelector(`#pattuglia-select option[value="${pVal}"]`);
                if (originalOption) {
                    spName.textContent = originalOption.textContent.split('(')[0].trim();
                    spCp.textContent = originalOption.getAttribute('data-cp');
                    spUnit.textContent = originalOption.getAttribute('data-unit');
                    summaryPattuglia.classList.remove('hidden');
                    hasP = true;
                }
            } else {
                summaryPattuglia.classList.add('hidden');
            }

            // Update Challenge
            if (cVal) {
                const originalOption = document.querySelector(`#challenge-select option[value="${cVal}"]`);
                if (originalOption) {
                    scName.textContent = originalOption.textContent.split('(+')[0].trim();
                    const points = originalOption.getAttribute('data-points');
                    scPoints.textContent = '+' + points;
                    totalPoints.textContent = '+' + points;

                    if (originalOption.getAttribute('data-fungo') === 'True') {
                        scFungo.classList.remove('hidden');
                    } else {
                        scFungo.classList.add('hidden');
                    }

                    summaryChallenge.classList.remove('hidden');
                    hasC = true;
                }
            } else {
                summaryChallenge.classList.add('hidden');
            }

            // Toggle Main Views
            if (hasP || hasC) {
                summaryEmpty.classList.add('hidden');
                summaryContent.classList.remove('hidden');
            } else {
                summaryEmpty.classList.remove('hidden');
                summaryContent.classList.add('hidden');
            }

            if (hasP && hasC) {
                summaryTotal.classList.remove('hidden');
            } else {
                summaryTotal.classList.add('hidden');
            }
        }

        pSelect.on('change', updateSummary);
        cSelect.on('change', updateSummary);
    });
</script>
{% endblock %}